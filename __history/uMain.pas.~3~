unit uMain;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.OleCtrls, SHDocVw,ActiveX,MSHTML,
  Vcl.ComCtrls, Vcl.ExtCtrls;

type
  TForm1 = class(TForm)
    Page1: TPageControl;
    Panel1: TPanel;
    btnLoad: TButton;
    Bar1: TStatusBar;
    ts1: TTabSheet;
    ts2: TTabSheet;
    ts3: TTabSheet;
    ts4: TTabSheet;
    Web1: TWebBrowser;
    Web2: TWebBrowser;
    Memo1: TMemo;
    Memo2: TMemo;
    edtUrl: TEdit;
    TabSheet1: TTabSheet;
    Memo3: TMemo;
    btnCopyContent: TButton;
    btnMerge: TButton;
    ts6: TTabSheet;
    Memo4: TMemo;
    procedure btnLoadClick(Sender: TObject);
    procedure Web1DocumentComplete(ASender: TObject; const pDisp: IDispatch;
      const URL: OleVariant);
    procedure Web1NavigateComplete2(ASender: TObject; const pDisp: IDispatch;
      const URL: OleVariant);
    procedure Web2DocumentComplete(ASender: TObject; const pDisp: IDispatch;
      const URL: OleVariant);
    procedure btnCopyContentClick(Sender: TObject);
    procedure btnMergeClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form1: TForm1;
procedure SaveSinglePage(doc:IHTMLDocument2;localPageName:string);//仅仅保存一个页面
function getPageCode(doc:IHTMLDocument2):tstrings;//返回页面源代码
function getPageContent(doc:IHTMLDocument2;tag:string):tstrings;//返回页面源代码
implementation

{$R *.dfm}
function getPageContent(doc:IHTMLDocument2;tag:string):tstrings;//返回页面源代码
var
  ms: TMemoryStream;
  ss:tstrings;
  content:ihtmlelement;
begin
  ss:=tstringlist.Create;
  content:=(doc.all.item(tag,0) as ihtmlelement);
  ss.Text:=content.outerHTML;
  result:=ss;
end;
function getPageCode(doc:IHTMLDocument2):tstrings;//返回页面源代码
var
  ms: TMemoryStream;
  ss:tstrings;
begin
 ms := TMemoryStream.Create;
 ss:=tstringlist.Create;
 (doc as IPersistStreamInit).Save(TStreamAdapter.Create(ms), True);
 ms.Position := 0;
 ss.LoadFromStream(ms,TEncoding.UTF8);
 ms.Free;
 result:=ss;
end;
procedure SaveSinglePage(doc:IHTMLDocument2;localPageName:string);//仅仅保存一个页面
var
  ms: TMemoryStream;
  ss:tstrings;
begin
 ms := TMemoryStream.Create;
 ss:=tstringlist.Create;
 (doc as IPersistStreamInit).Save(TStreamAdapter.Create(ms), True);
 ms.Position := 0;
 ss.LoadFromStream(ms,TEncoding.UTF8);
 ss.SaveToFile(localPageName,TEncoding.UTF8);
 ms.Free;
 ss.Free;
end;
procedure TForm1.btnCopyContentClick(Sender: TObject);
var
  doc:IHTMLDocument2;
begin
  doc:=web1.Document as IHTMLDocument2; //得到接口；
  memo3.Lines:=getpagecontent(doc,'article_content');
  bar1.Panels[0].Text:='加载完毕！';
end;

procedure TForm1.btnLoadClick(Sender: TObject);
begin
  page1.ActivePageIndex:=0;
  web1.Navigate(edturl.Text);
  web2.Navigate('C:\tmp\2\csdnmodel.htm');
end;

procedure TForm1.btnMergeClick(Sender: TObject);
var
  doc1,doc2:IHTMLDocument2;
  ss:tstrings;
begin
  doc1:=web1.Document as IHTMLDocument2; //得到接口；
  ss:=getpagecontent(doc1,'article_content');
  memo1.Lines:=ss;
  doc2:=web2.Document as IHTMLDocument2; //得到接口；
  //doc2.body.innerHTML:=ss.Text;
  doc2.body.innerHTML:='aa';
  memo4.Lines:=getpagecode(doc2);
end;

procedure TForm1.Web1DocumentComplete(ASender: TObject; const pDisp: IDispatch;
  const URL: OleVariant);
var
  doc:IHTMLDocument2;
begin
  //if bDocComplete then exit;
  //bDocComplete:=true;
  doc:=web1.Document as IHTMLDocument2; //得到接口；
  memo1.Lines:=getpagecode(doc);
  bar1.Panels[0].Text:='加载完毕！';
end;

procedure TForm1.Web1NavigateComplete2(ASender: TObject; const pDisp: IDispatch;
  const URL: OleVariant);
begin
  web1.Silent := True;
end;

procedure TForm1.Web2DocumentComplete(ASender: TObject; const pDisp: IDispatch;
  const URL: OleVariant);
var
  doc:IHTMLDocument2;
begin
  doc:=web2.Document as IHTMLDocument2; //得到接口；
  memo2.Lines:=getpagecode(doc);
  bar1.Panels[0].Text:='加载完毕！';

end;

end.
